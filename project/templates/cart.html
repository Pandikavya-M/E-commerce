<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/cart.css' %}">

    <link rel="stylesheet" href="{% static 'bootstrap-5.3.3-dist/css/bootstrap.min.css' %}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Playwrite Danmark Loopet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/dist/alertify.min.js"></script>
</head>
<body>
    {% include 'nav.html' %}
<div class="container" style="margin-top: 100px;">
    <div class="row product_data">
        <h3>Your Cart</h3>
        <hr>
        <div class="col-12 col-sm-12 col-md-7 col-lg-8" style="margin-right: 40px;">
            {% for y in cart %}
                <div class="row item">
                    <div class="col-4 col-sm-4 col-md-4 col-lg-4 image">
                        <img src="{{ y.product.prod_image.url }}" class="card-img-top img-fluid" alt="No image">
                    </div>
                    <div class="col-8 col-sm-8 col-md-8 col-lg-8  para ">
                        <h5 class="card-title">{{y.product.name}}</h5>

                        <input type="hidden" value="{{y.id}}" class="prod_id">
                        {% csrf_token %}

                        <p>
                            <div class="input-group input-group-sm" style="width: 100px;">
                                <button class="input-group-text bg-warning text-dark btn-minus"><i class="fa fa-minus"></i></button>
                                <input type="type" name="qty" class="form-control text-center qty-input" value="{{ y.prod_qty }}">
                                <button class="input-group-text bg-warning text-dark btn-plus"><i class="fa fa-plus"></i></button>
                                <button class="btn btn-outline-warning btnEnter">Enter</button>
                            </div>

                        </p>
                        
                        <p class="card-text ">₹{{y.product.off_price}}  <span>₹{{y.product.original_price}}</span></p>
                        <p class="card-text cost">Price:₹{{y.total_cost}}</p>
                        <div class="product">
                            <button class="close" data-product-id="{{ product.id }}"><i class="fa fa-close"></i></button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div class="col-12 col-sm-12 col-md-4 col-lg-3  price">
            <h4>Price details</h4>
            <div class="row">
                <div class="col pricepara">
                    <p>Total MRP</p>
                    <p>Platform Fee</p>
                    <p>Shipment</p>
                    <hr>
                    <p>Amount</p>
                    <!-- <p id="amt"></p>     -->
                </div>
                <div class="col priceans">
                    <p id="amt"></p>
                    <p>Free</p>
                    <p>Free</p>
                    <hr>
                    <p id="amount"></p>    
                </div>
            </div>
            <button class="btn btn-warning">Place Order</button>
        </div>
    </div>        
</div>


    <script>
        document.addEventListener("DOMContentLoaded", function(event) {
            const items = document.querySelectorAll('.item');
            
    
            items.forEach(function(item) {
                const btnPlus = item.querySelector('.btn-plus');
                const btnMinus = item.querySelector('.btn-minus');
                const txtQty = item.querySelector('.qty-input');
    
                btnPlus.addEventListener("click", function() {
                    let qty = parseInt(txtQty.value, 10);
                    qty = isNaN(qty) ? 0 : qty;
                    if (qty < 10) {
                        qty++;
                        txtQty.value = qty;
                    }
                });
    
                btnMinus.addEventListener("click", function() {
                    let qty = parseInt(txtQty.value, 10);
                    qty = isNaN(qty) ? 0 : qty;
                    if (qty > 1) {
                        qty--;
                        txtQty.value = qty;
                    }
                });
    
            });
        });

       
    console.log('updateCart function called');
    console.log('Button elements:', $('.btnEnter'));
    $('.btnEnter').click(function (e){
        console.log('Button clicked');
        e.preventDefault();

        const item = $(this).closest('.item');
        const product_id = item.find('.prod_id').val();
        const product_qty = item.find('.qty-input').val();
        const token =$('input[name="csrfmiddlewaretoken"]').val();

        $.ajax({
            type: 'POST',
            url: '/update-cart/',
            data: {
                "product_id": product_id,
                "quantity": product_qty,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Cart updated successfully!');
                item.find('.qty-input').val(product_qty);
                if (response.status === 'Product updated') {
                alert('Cart updated successfully!');
                window.location.href = '/view_cart';
                } else {
                    alert('Error: ' + response.status);
                }
            },
            error: function(xhr, status, error) {
                console.log('Error updating cart:', error);
            }
        });   
    });

    $('.close').click(function (e){
        e.preventDefault();

        const item = $(this).closest('.item');
        const product_id = item.find('.prod_id').val();
        const token =$('input[name="csrfmiddlewaretoken"]').val();

        $.ajax({
            method: 'POST',
            url: 'close',
            data: {
                "product_id": product_id,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Cart updated successfully!');
                
                if (response.status === 'Product deleted') {
                    item.fadeOut(300, function() {
                        $(this).remove();
                    });
                }
            },
            error: function(xhr, status, error) {
                console.log('Error updating cart:', error);
            }
        });   

    });

    const nodes = document.querySelectorAll('.cost');
    const arr = Array.from(nodes);
    const res = arr.reduce((acc, curr) => {
    const numericValue = parseFloat(curr.textContent.replace(/[^\d\.]+/g, ''));
    return acc + numericValue;
    }, 0);
    document.getElementById('amt').innerHTML = "₹ " + res.toFixed(1);
    document.getElementById('amount').innerHTML = "₹ " + res.toFixed(1);

    
     </script>

    {% include 'footer.html' %}
    <script src="{% static 'bootstrap-5.3.3-dist/js/bootstrap.bundle.min.js' %}"></script>
</body>
</html>